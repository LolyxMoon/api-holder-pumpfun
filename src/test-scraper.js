// src/test-scraper-fixed.js - Version corregida para Puppeteer nuevo
const puppeteer = require('puppeteer');
const axios = require('axios');
require('dotenv').config();

const TOKEN_ADDRESS = process.env.TOKEN_ADDRESS || '9X2apRBS8GACA9nbP44GJt46Py6JjSNFGvB14SXmpump';

// Helper para esperar
const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

async function testScraping() {
    console.log('üîç Iniciando prueba de scraping...');
    console.log('Token:', TOKEN_ADDRESS);
    console.log('URL Solscan:', `https://solscan.io/token/${TOKEN_ADDRESS}`);
    
    // M√©todo 1: Probar API directa de Solscan
    console.log('\nüìä M√©todo 1: API de Solscan...');
    try {
        const response = await axios.get(
            `https://api.solscan.io/token/holder/list`,
            {
                params: {
                    address: TOKEN_ADDRESS,
                    offset: 0,
                    size: 20
                },
                headers: {
                    'Accept': 'application/json',
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                },
                timeout: 10000
            }
        );
        
        if (response.data && response.data.data) {
            console.log(`‚úÖ API funcion√≥! Holders encontrados: ${response.data.data.total}`);
            return response.data.data.result;
        }
    } catch (error) {
        console.log(`‚ùå API fall√≥: ${error.message} (Esto es normal, Solscan requiere API key)`);
    }

    // M√©todo 2: Probar con Helius RPC (necesita API key)
    console.log('\n‚õìÔ∏è M√©todo 2: Helius RPC...');
    try {
        // Helius con API key gratuita
        const HELIUS_API_KEY = process.env.HELIUS_API_KEY || 'tu-api-key-aqui';
        const response = await axios.post(
            `https://mainnet.helius-rpc.com/?api-key=${HELIUS_API_KEY}`,
            {
                jsonrpc: '2.0',
                id: 'test-holders',
                method: 'getTokenLargestAccounts',
                params: [TOKEN_ADDRESS]
            },
            {
                headers: { 'Content-Type': 'application/json' },
                timeout: 10000
            }
        );
        
        if (response.data && response.data.result && response.data.result.value) {
            const holders = response.data.result.value;
            console.log(`‚úÖ Helius funcion√≥! Holders encontrados: ${holders.length}`);
            return holders;
        }
    } catch (error) {
        console.log(`‚ùå Helius fall√≥: ${error.message} (Necesita API key - obt√©n una gratis en helius.dev)`);
    }

    // M√©todo 3: Scraping visual con Puppeteer
    console.log('\nüåê M√©todo 3: Scraping con Puppeteer (modo visible)...');
    console.log('‚è≥ Abriendo navegador...');
    
    const browser = await puppeteer.launch({
        headless: false, // Modo visible para debug
        defaultViewport: { width: 1920, height: 1080 },
        args: ['--no-sandbox', '--disable-setuid-sandbox']
    });

    try {
        const page = await browser.newPage();
        
        // Configurar user agent
        await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36');
        
        const url = `https://solscan.io/token/${TOKEN_ADDRESS}`;
        console.log(`üìç Navegando a: ${url}`);
        
        await page.goto(url, { waitUntil: 'networkidle2', timeout: 60000 });
        
        console.log('‚è≥ Esperando que cargue la p√°gina...');
        await delay(5000); // Esperar 5 segundos
        
        // Intentar hacer click en el tab de holders
        console.log('üîç Buscando tab de holders...');
        
        const holdersTabClicked = await page.evaluate(() => {
            // Buscar el tab de holders con varios selectores
            const selectors = [
                'a[href="#holders"]',
                'a[href*="holders"]',
                '.ant-tabs-tab:contains("Holders")',
                'div[role="tab"]:contains("Holders")',
                '[data-node-key="holders"]'
            ];
            
            for (const selector of selectors) {
                try {
                    const element = document.querySelector(selector);
                    if (element) {
                        element.click();
                        return true;
                    }
                } catch (e) {}
            }
            
            // Buscar por texto
            const allElements = document.querySelectorAll('*');
            for (const el of allElements) {
                if (el.textContent === 'Holders' && (el.tagName === 'A' || el.tagName === 'BUTTON' || el.role === 'tab')) {
                    el.click();
                    return true;
                }
            }
            
            return false;
        });
        
        if (holdersTabClicked) {
            console.log('‚úÖ Tab de holders clickeado');
            await delay(3000);
        } else {
            console.log('‚ö†Ô∏è No se encontr√≥ tab de holders, continuando...');
        }
        
        // Hacer scroll para cargar m√°s datos
        console.log('üìú Haciendo scroll para cargar m√°s datos...');
        await page.evaluate(() => window.scrollTo(0, document.body.scrollHeight));
        await delay(2000);
        
        // Intentar extraer holders
        console.log('üìä Extrayendo holders...');
        
        const holders = await page.evaluate(() => {
            const results = [];
            
            // Debug: ver qu√© hay en la p√°gina
            console.log('Debug - Buscando elementos...');
            const tables = document.querySelectorAll('table');
            console.log(`Tablas encontradas: ${tables.length}`);
            
            // Buscar en todas las posibles ubicaciones
            let rows = [];
            
            // Opci√≥n 1: Tabla Ant Design
            rows = document.querySelectorAll('.ant-table-tbody tr');
            console.log(`Filas ant-table: ${rows.length}`);
            
            // Opci√≥n 2: Tabla normal
            if (rows.length === 0) {
                tables.forEach(table => {
                    const tableRows = table.querySelectorAll('tbody tr');
                    if (tableRows.length > 0) {
                        rows = tableRows;
                        console.log(`Filas en tabla: ${tableRows.length}`);
                    }
                });
            }
            
            // Opci√≥n 3: Divs con estructura de lista
            if (rows.length === 0) {
                rows = document.querySelectorAll('[class*="holder"], [class*="account"], .list-item');
                console.log(`Items de lista: ${rows.length}`);
            }
            
            // Procesar las filas encontradas
            rows.forEach((row, index) => {
                const text = row.textContent || '';
                
                // Buscar direcciones de Solana (32-44 caracteres base58)
                const addressMatch = text.match(/[1-9A-HJ-NP-Za-km-z]{32,44}/);
                
                if (addressMatch) {
                    // Buscar n√∫meros que podr√≠an ser balance
                    const numbers = text.match(/[\d,]+\.?\d*/g) || [];
                    let balance = 0;
                    
                    // Tomar el primer n√∫mero grande como balance
                    for (const num of numbers) {
                        const parsed = parseFloat(num.replace(/,/g, ''));
                        if (parsed > 0) {
                            balance = parsed;
                            break;
                        }
                    }
                    
                    results.push({
                        rank: index + 1,
                        address: addressMatch[0],
                        balance: balance,
                        text: text.substring(0, 200) // Para debug
                    });
                }
            });
            
            // Si no encontramos nada, buscar de forma m√°s agresiva
            if (results.length === 0) {
                console.log('B√∫squeda agresiva de holders...');
                const allText = document.body.innerText;
                const addresses = allText.match(/[1-9A-HJ-NP-Za-km-z]{32,44}/g) || [];
                
                addresses.slice(0, 10).forEach((addr, i) => {
                    results.push({
                        rank: i + 1,
                        address: addr,
                        balance: 0,
                        text: 'Found in page text'
                    });
                });
            }
            
            return results;
        });
        
        console.log(`\nüìä Holders encontrados: ${holders.length}`);
        
        if (holders.length > 0) {
            console.log('\nüéØ Primeros 5 holders:');
            holders.slice(0, 5).forEach(h => {
                console.log(`  ${h.rank}. ${h.address.slice(0,8)}...${h.address.slice(-6)}`);
                console.log(`     Balance: ${h.balance || 'No detectado'}`);
            });
        } else {
            console.log('‚ùå No se encontraron holders');
            console.log('\nüí° Posibles razones:');
            console.log('  - El token no existe en Solscan');
            console.log('  - La p√°gina tiene una estructura diferente');
            console.log('  - El token no tiene holders a√∫n');
        }
        
        // Tomar screenshot para debug
        await page.screenshot({ path: 'debug-screenshot.png', fullPage: true });
        console.log('\nüì∏ Screenshot guardado como debug-screenshot.png');
        
        // Esperar un poco antes de cerrar para que puedas ver
        console.log('\n‚è≥ Cerrando en 5 segundos...');
        await delay(5000);
        
        return holders;
        
    } catch (error) {
        console.error('‚ùå Error durante scraping:', error);
    } finally {
        await browser.close();
        console.log('‚úÖ Browser cerrado');
    }
}

// M√©todo 4: Generar holders de prueba
function generateTestHolders() {
    console.log('\nüé≤ Generando holders de prueba para desarrollo...');
    
    const holders = [];
    for (let i = 0; i < 50; i++) {
        const chars = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
        let address = '';
        for (let j = 0; j < 44; j++) {
            address += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        
        holders.push({
            rank: i + 1,
            address: address,
            balance: Math.floor(Math.random() * 1000000) / (i + 1),
            percentage: (20 / (i + 1)).toFixed(2)
        });
    }
    
    console.log(`‚úÖ Generados ${holders.length} holders de prueba`);
    console.log('\nüìù Para usar estos datos de prueba, agrega a tu .env:');
    console.log('   USE_MOCK_DATA=true');
    
    return holders;
}

// Ejecutar pruebas
console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
console.log('   TEST DE SCRAPING DE HOLDERS');
console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

testScraping()
    .then(() => {
        console.log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('‚úÖ Test completado');
        console.log('\nüí° Recomendaciones:');
        console.log('1. Si ning√∫n m√©todo funcion√≥, usa USE_MOCK_DATA=true en .env');
        console.log('2. Para Helius, obt√©n API key gratis en https://helius.dev');
        console.log('3. Revisa el screenshot para ver qu√© vio el scraper');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        
        // Generar datos de prueba como alternativa
        generateTestHolders();
    })
    .catch(error => {
        console.error('‚ùå Error fatal:', error);
        process.exit(1);
    });